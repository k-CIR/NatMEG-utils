// App state management and UI controller
let currentConfig = null;
let conversionStatus = 'not-run';

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
    initializeNavigation();
    initializeConfigForm();
    initializeRunControls();
    
    // Load default config if available
    loadDefaultConfig();
});

// Navigation
function initializeNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const viewId = item.dataset.view;
            switchView(viewId);
        });
    });
    
    // Navigation buttons
    document.getElementById('nextToRunBtn').addEventListener('click', () => {
        if (validateConfig()) {
            switchView('run');
        }
    });
    
    document.getElementById('backToConfigBtn').addEventListener('click', () => {
        switchView('config');
    });
    
    document.getElementById('nextToReviewBtn').addEventListener('click', () => {
        switchView('review');
    });
    
    document.getElementById('rerunBidsifyBtn').addEventListener('click', () => {
        switchView('run');
        runBidsification();
    });
    
    document.getElementById('openTableBtn').addEventListener('click', async () => {
        if (window.electronAPI) {
            const fileData = await window.electronAPI.openFile();
            if (fileData) {
                // Load TSV in iframe
                const iframe = document.querySelector('#review iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'load-file',
                        data: fileData
                    }, '*');
                }
            }
        }
    });
}

function switchView(viewId) {
    // Update nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewId);
    });
    
    // Update content views
    document.querySelectorAll('.content-view').forEach(view => {
        view.classList.toggle('active', view.id === viewId);
    });
}

// Configuration Form
function initializeConfigForm() {
    document.getElementById('loadConfigBtn').addEventListener('click', loadConfigFile);
    document.getElementById('saveConfigBtn').addEventListener('click', saveConfigFile);
    
    // Auto-save config on input change
    document.getElementById('configForm').addEventListener('change', () => {
        currentConfig = collectConfigFromForm();
    });
}

async function loadDefaultConfig() {
    if (window.electronAPI) {
        try {
            const config = await window.electronAPI.loadDefaultConfig();
            if (config) {
                populateConfigForm(config);
                currentConfig = config;
            }
        } catch (error) {
            console.error('Error loading default config:', error);
        }
    }
}

async function loadConfigFile() {
    if (window.electronAPI) {
        const result = await window.electronAPI.loadConfig();
        if (result && result.config) {
            populateConfigForm(result.config);
            currentConfig = result.config;
            alert('✅ Configuration loaded successfully');
        }
    }
}

async function saveConfigFile() {
    const config = collectConfigFromForm();
    if (!validateConfig()) {
        return;
    }
    
    if (window.electronAPI) {
        const result = await window.electronAPI.saveConfig(config);
        if (result.success) {
            alert('✅ Configuration saved successfully');
        } else {
            alert('❌ Error saving configuration: ' + result.error);
        }
    }
}

function populateConfigForm(config) {
    // Project settings
    document.getElementById('config_project_name').value = config.Project?.Name || '';
    document.getElementById('config_cir_id').value = config.Project?.['CIR-ID'] || '';
    
    // Paths
    document.getElementById('config_raw_path').value = config.Project?.Raw || '';
    document.getElementById('config_bids_path').value = config.Project?.BIDS || '';
    
    // BIDS metadata
    document.getElementById('config_authors').value = config.BIDS?.authors || '';
    document.getElementById('config_license').value = config.BIDS?.data_license || '';
    document.getElementById('config_description').value = config.Project?.Description || '';
    
    // Conversion settings
    document.getElementById('config_conversion_file').value = config.BIDS?.Conversion_file || 'bids_conversion.tsv';
    document.getElementById('config_overwrite').value = config.BIDS?.overwrite ? 'true' : 'false';
}

function collectConfigFromForm() {
    return {
        Project: {
            Name: document.getElementById('config_project_name').value,
            'CIR-ID': document.getElementById('config_cir_id').value,
            Raw: document.getElementById('config_raw_path').value,
            BIDS: document.getElementById('config_bids_path').value,
            Description: document.getElementById('config_description').value,
            InstitutionName: 'Karolinska Institutet',
            InstitutionAddress: 'Nobels vag 9, 171 77, Stockholm, Sweden',
            InstitutionDepartmentName: 'Department of Clinical Neuroscience (CNS)'
        },
        BIDS: {
            Conversion_file: document.getElementById('config_conversion_file').value,
            overwrite: document.getElementById('config_overwrite').value === 'true',
            authors: document.getElementById('config_authors').value,
            data_license: document.getElementById('config_license').value
        }
    };
}

function validateConfig() {
    const projectName = document.getElementById('config_project_name').value;
    const rawPath = document.getElementById('config_raw_path').value;
    const bidsPath = document.getElementById('config_bids_path').value;
    
    if (!projectName || !rawPath || !bidsPath) {
        alert('⚠️ Please fill in all required fields (marked with *)');
        return false;
    }
    
    return true;
}

// Run Controls
function initializeRunControls() {
    document.getElementById('runBidsifyBtn').addEventListener('click', runBidsification);
}

async function runBidsification() {
    if (!validateConfig()) {
        return;
    }
    
    const config = collectConfigFromForm();
    const runStatus = document.getElementById('runStatus');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const consoleOutput = document.getElementById('consoleOutput');
    const runButton = document.getElementById('runBidsifyBtn');
    const nextButton = document.getElementById('nextToReviewBtn');
    
    // Update UI for running state
    runStatus.className = 'run-status running';
    runStatus.innerHTML = '<h3>⚙️ Running BIDSification...</h3><p>Please wait while the conversion runs</p>';
    runButton.disabled = true;
    progressContainer.style.display = 'block';
    consoleOutput.style.display = 'block';
    consoleOutput.innerHTML = '';
    progressBar.style.width = '10%';
    
    // Run bidsify via Electron
    if (window.electronAPI) {
        try {
            const result = await window.electronAPI.runBidsify(config, (data) => {
                // Progress callback
                appendConsoleOutput(data.line);
                
                if (data.progress) {
                    progressBar.style.width = data.progress + '%';
                }
            });
            
            if (result.success) {
                // Success
                progressBar.style.width = '100%';
                runStatus.className = 'run-status success';
                runStatus.innerHTML = '<h3>✅ Conversion Completed Successfully!</h3><p>Conversion table has been generated</p>';
                conversionStatus = 'completed';
                nextButton.disabled = false;
                
                // Auto-advance to review after 2 seconds
                setTimeout(() => {
                    switchView('review');
                    // Load the generated TSV
                    loadConversionTable(config);
                }, 2000);
                
            } else {
                // Error
                runStatus.className = 'run-status error';
                runStatus.innerHTML = '<h3>❌ Conversion Failed</h3><p>' + (result.error || 'Unknown error') + '</p>';
                conversionStatus = 'error';
                appendConsoleOutput('\n❌ ERROR: ' + result.error, 'error');
            }
        } catch (error) {
            runStatus.className = 'run-status error';
            runStatus.innerHTML = '<h3>❌ Conversion Failed</h3><p>' + error.message + '</p>';
            conversionStatus = 'error';
            appendConsoleOutput('\n❌ ERROR: ' + error.message, 'error');
        } finally {
            runButton.disabled = false;
        }
    } else {
        // Not running in Electron
        appendConsoleOutput('❌ This feature requires running in the Electron app', 'error');
        runButton.disabled = false;
    }
}

async function loadConversionTable(config) {
    const tsvPath = config.Project.BIDS + '/conversion_logs/' + config.BIDS.Conversion_file;
    
    if (window.electronAPI) {
        const fileData = await window.electronAPI.loadConversionTable(tsvPath);
        if (fileData) {
            const iframe = document.querySelector('#review iframe');
            if (iframe && iframe.contentWindow) {
                // Wait for iframe to load
                iframe.onload = () => {
                    iframe.contentWindow.postMessage({
                        type: 'load-file',
                        data: fileData
                    }, '*');
                };
            }
        }
    }
}

function appendConsoleOutput(text, type = 'normal') {
    const consoleOutput = document.getElementById('consoleOutput');
    const line = document.createElement('div');
    line.className = 'line ' + type;
    line.textContent = text;
    consoleOutput.appendChild(line);
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
}
