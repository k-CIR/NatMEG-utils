<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIDS Conversion Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f8f8;
            padding: 20px;
            color: #000000;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 30px;
            border-top: 4px solid #860052;
        }
        
        h1 {
            color: #860052;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #555555;
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .file-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .file-selector label {
            font-weight: 600;
            color: #555;
        }
        
        .file-selector input[type="radio"] {
            margin-right: 5px;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #860052;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #98C9A3 0%, #7ab88a 100%);
            color: #000000;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #860052;
        }
        
        .stat-card .label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .filters {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-bottom: 20px;
            align-items: flex-end;
            overflow-x: auto;
            padding-bottom: 2px;
            scrollbar-width: thin;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
        }
        
        .filter-status {
            order: -1;
        }
        
        .filter-status label {
            color: #860052;
            font-size: 13px;
        }
        
        .filter-status select {
            border: 2px solid #860052;
            font-weight: 600;
        }
        
        .filter-group select {
            padding: 6px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            min-width: 80px;
            max-width: 120px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #860052;
        }
        
        .clear-filters {
            padding: 6px 12px;
            background: #860052;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            margin-left: 8px;
        }
        
        .clear-filters:hover {
            background: #660040;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            background: linear-gradient(135deg, #860052 0%, #660040 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            position: relative;
        }
        
        th[data-column="status"] {
            min-width: 90px;
        }
        th[data-column="task"] {
            min-width: 60px;
            max-width: 100px;
        }
        th[data-column="description"] {
            min-width: 60px;
            max-width: 100px;
        }

        th[data-column="bids_name"] {
            min-width: 220px;
            max-width: 400px;
        }
        
        th[data-column="split"],
        th[data-column="run"] {
            min-width: 40px;
            max-width: 60px;
        }
        
        th:hover {
            background: rgba(255,255,255,0.1);
        }
        
        th::after {
            content: '';
            margin-left: 5px;
            opacity: 0.5;
        }
        
        th.sort-asc::after {
            content: '‚ñ≤';
            opacity: 1;
        }
        
        th.sort-desc::after {
            content: '‚ñº';
            opacity: 1;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        td.col-status {
            min-width: 60px;
        }
        td.col-task {
            min-width: 60px;
            max-width: 100px;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        td.col-task input {
            width: 100%;
            max-width: 100px;
            box-sizing: border-box;
        }
        td.col-description {
            min-width: 60px;
            max-width: 100px;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        td.col-description input {
            width: 100%;
            max-width: 100px;
            box-sizing: border-box;
        }

        td.col-bids_name {
            min-width: 220px;
            max-width: 400px;
        }
        
        td.col-split,
        td.col-run {
            min-width: 20px;
            max-width: 30px;
        }
        
        td.col-split input,
        td.col-run input {
            max-width: 30px;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr:nth-child(even) {
            background: #fafafa;
        }
        
        tbody tr:nth-child(even):hover {
            background: #f0f0f0;
        }
        
        tbody tr.skip-row {
            color: #999;
            opacity: 0.7;
        }
        
        tbody tr.skip-row:hover {
            opacity: 0.9;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        
        .status-processed, .status-success {
            background: #98C9A3;
            color: #000000;
            font-weight: 600;
        }
        
        .status-run {
            background: #ffd966;
            color: #000000;
            font-weight: 600;
        }
        
        .status-check {
            background: #ffb3b3;
            color: #860052;
            font-weight: 600;
        }
        
        .status-skip {
            background: #e0e0e0;
            color: #000000;
            font-weight: 600;
        }
        
        .file-path {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            word-break: break-all;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .editable-cell {
            cursor: text;
            position: relative;
        }
        
        .save-button {
            padding: 10px 20px;
            background: #98C9A3;
            color: #000000;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
            transition: background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .save-button:hover {
            background: #7ab88a;
        }
        
        .save-button:disabled {
            background: #d0d0d0;
            color: #808080;
            cursor: not-allowed;
        }
        
        .reset-button {
            padding: 10px 20px;
            background: #860052;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
            transition: background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .reset-button:hover {
            background: #660040;
        }
        
        .reset-button:disabled {
            background: #d0d0d0;
            color: #808080;
            cursor: not-allowed;
        }
        
        .modified {
            background: #fff3cd !important;
        }
        
        .bulk-status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .bulk-status-bar label {
            font-weight: 600;
            color: #555;
        }
        
        .bulk-status-bar select {
            padding: 6px 8px;
            border: 2px solid #860052;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .bulk-status-bar select:focus {
            outline: none;
            border-color: #660040;
        }
        
        .bulk-status-bar button {
            padding: 6px 12px;
            background: #98C9A3;
            color: #000000;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .bulk-status-bar button:hover {
            background: #7ab88a;
        }
        
        .duplicate-row {
            background: #ffe6e6 !important;
        }
        .duplicate-cell {
            background: #ffcccc !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† NatMEG BIDS Editor</h1>
        <p class="subtitle">Interactive BIDS editor for MEG-data</p>
        
        <div class="controls">
            <input type="file" id="fileInput" accept=".tsv" style="display:none" onchange="handleFileSelect(event)">
            <button class="save-button" onclick="document.getElementById('fileInput').click()" style="background:#3498db;">üìÇ Open TSV File</button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Search in all columns...">
            </div>
            <button class="save-button" id="saveButton" onclick="saveChanges()" disabled>üíæ Save Changes</button>
            <button class="reset-button" id="resetButton" onclick="resetChanges()" disabled>üîÑ Reset Changes</button>
        </div>
        
        <div class="stats" id="stats"></div>
        
        <div class="filters" id="filters"></div>
        
        <div id="errorMessage"></div>
        
        <div class="bulk-status-bar" style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
            <label for="bulkStatusSelect">Bulk status:</label>
            <select id="bulkStatusSelect">
                <option value="">Set status...</option>
                <option value="processed">processed</option>
                <option value="run">run</option>
                <option value="skip">skip</option>
                <option value="check">check</option>
            </select>
            <button onclick="bulkChangeStatus(document.getElementById('bulkStatusSelect').value)" id="bulkStatusButton">Apply</button>
        </div>
        
        <div class="table-container">
            <div id="loading" class="loading">Loading data...</div>
            <table id="dataTable" style="display: none;">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="noData" class="no-data" style="display: none;">No data matches your filters</div>
        </div>
    </div>
    
    <script>
        let allData = [];
        let filteredData = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let columns = [];
        let filterValues = {};
        let modifiedRows = new Set();
        let manualStatusChanges = new Set();
        let originalData = [];
        let currentFilePath = '';
        const editableColumns = ['task', 'run', 'description'];
        const statusOptions = ['processed', 'run', 'skip', 'check'];
        const hiddenColumns = ['split', 'raw_path', 'bids_path', 'event_id', 'participant_to', 'session_to'];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Event listeners
            document.getElementById('searchInput').addEventListener('input', filterData);
            
            // Show message to open file
            document.getElementById('loading').innerHTML = 'üìÇ Please select a TSV file to begin';
        });
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const loading = document.getElementById('loading');
            const table = document.getElementById('dataTable');
            const errorDiv = document.getElementById('errorMessage');
            
            loading.style.display = 'block';
            loading.innerHTML = 'Loading data...';
            table.style.display = 'none';
            errorDiv.innerHTML = '';
            
            try {
                // Read file content
                const text = await file.text();
                
                // Store the file name as path (we'll use this for saving)
                currentFilePath = file.name;
                
                // Parse TSV
                const lines = text.trim().split('\n');
                const headers = lines[0].split('\t');
                columns = headers;
                
                allData = lines.slice(1).map(line => {
                    const values = line.split('\t');
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index] || '';
                    });
                    return obj;
                });
                
                // Add unique index to each row
                allData.forEach((row, index) => {
                    row._originalIndex = index;
                });
                
                // Store a deep copy of original data
                originalData = JSON.parse(JSON.stringify(allData));
                
                filterData();
                renderTable();
                loading.style.display = 'none';
                table.style.display = 'table';
            } catch (error) {
                loading.style.display = 'none';
                errorDiv.innerHTML = `<div class="error">‚ùå Error loading file: ${error.message}</div>`;
                console.error('Error loading file:', error);
            }
        }
        

        
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            // Filter only, do not sort unless user requested
            let filtered = allData.filter(row => {
                // Apply column filters
                for (const [column, value] of Object.entries(filterValues)) {
                    if (value && row[column] !== value) {
                        return false;
                    }
                }
                // Apply search filter
                if (searchTerm) {
                    return Object.values(row).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                }
                return true;
            });
            // Only sort if sortColumn is set by user
            if (sortColumn) {
                filtered.sort((a, b) => {
                    let valA = a[sortColumn] || '';
                    let valB = b[sortColumn] || '';
                    // Try to parse as numbers
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return sortDirection === 'asc' ? numA - numB : numB - numA;
                    }
                    // String comparison
                    return sortDirection === 'asc' 
                        ? String(valA).localeCompare(String(valB))
                        : String(valB).localeCompare(String(valA));
                });
            }
            filteredData = filtered;
            updateStats();
            renderTableBody();
        }
        
        function updateStats() {
            const statsDiv = document.getElementById('stats');
            const stats = [
                { label: 'Total Files', value: allData.length },
                { label: 'Filtered', value: filteredData.length }
            ];
            
            // Add status counts if available
            const statusField = columns.find(c => c.toLowerCase().includes('status'));
            if (statusField) {
                const statusCounts = {};
                filteredData.forEach(row => {
                    const status = row[statusField] || 'unknown';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                
                for (const [status, count] of Object.entries(statusCounts)) {
                    stats.push({ label: status, value: count });
                }
            }
            
            statsDiv.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="label">${stat.label}</div>
                    <div class="value">${stat.value}</div>
                </div>
            `).join('');
        }
        
        function renderTable() {
            renderTableHead();
            renderFilters();
            renderTableBody();
        }
        
        function renderTableHead() {
            // Move status to the left, add bulk checkbox column
            let orderedCols = columns.filter(col => !hiddenColumns.includes(col) && col !== 'event_id' && col !== 'participant_to' && col !== 'session_to');
            // Move status to first, then raw_name, then task
            const statusIdx = orderedCols.indexOf('status');
            if (statusIdx > 0) {
                orderedCols.splice(statusIdx, 1);
                orderedCols.unshift('status');
            }
            const rawNameIdx = orderedCols.indexOf('raw_name');
            if (rawNameIdx > 1) {
                orderedCols.splice(rawNameIdx, 1);
                orderedCols.splice(1, 0, 'raw_name');
            }
            const taskIdx = orderedCols.indexOf('task');
            if (taskIdx > 2) {
                orderedCols.splice(taskIdx, 1);
                orderedCols.splice(2, 0, 'task');
            }
            tableHead.innerHTML = `
                <tr>
                    <th style="width:32px;"><input type="checkbox" id="bulkSelectAll" onclick="toggleBulkSelectAll(this)"></th>
                    ${orderedCols.map(col => `
                        <th onclick="sortTable('${col}')" data-column="${col}" class="${sortColumn === col ? 'sort-' + sortDirection : ''}">
                            ${col}
                        </th>
                    `).join('')}
                </tr>
            `;
        }
        
        function renderFilters() {
            const filtersDiv = document.getElementById('filters');
            
            // Status filter is always first and most prominent
            const statusColumn = columns.find(col => col.toLowerCase() === 'status');
            
            // Columns to exclude from filters
            const excludedColumns = ['raw_path', 'raw_name', 'bids_path', 'bids_name', 'event_id', 'participant_to', 'session_to'];
            
            // Priority filters that should always be included
            const priorityColumns = ['participant_from', 'session_from'];
            
            // Determine which columns should have filters (not file paths, dates, etc.)
            const filterableColumns = columns.filter(col => {
                // Exclude specific columns
                if (excludedColumns.includes(col)) return false;
                
                // Include priority columns
                if (priorityColumns.includes(col)) return true;
                
                const sampleValues = new Set(allData.slice(0, 100).map(row => row[col]));
                return sampleValues.size > 1 && sampleValues.size < 50; // Reasonable number of unique values
            });
            
            // Ensure status is first, then priority columns, then others
            let orderedColumns = [];
            if (statusColumn) {
                orderedColumns.push(statusColumn);
            }
            priorityColumns.forEach(col => {
                if (filterableColumns.includes(col) && col !== statusColumn) {
                    orderedColumns.push(col);
                }
            });
            filterableColumns.forEach(col => {
                if (!orderedColumns.includes(col)) {
                    orderedColumns.push(col);
                }
            });
            
            filtersDiv.innerHTML = orderedColumns.map((col, index) => {
                const uniqueValues = [...new Set(allData.map(row => row[col]))].filter(v => v).sort();
                const isStatus = col.toLowerCase() === 'status';
                const groupClass = isStatus ? 'filter-group filter-status' : 'filter-group';
                
                return `
                    <div class="${groupClass}">
                        <label>${isStatus ? '‚≠ê ' : ''}${col}</label>
                        <select onchange="updateFilter('${col}', this.value)">
                            <option value="">All</option>
                            ${uniqueValues.map(val => `
                                <option value="${val}" ${filterValues[col] === val ? 'selected' : ''}>
                                    ${val}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }).join('') + (orderedColumns.length > 0 ? '<button class="clear-filters" onclick="clearFilters()">Clear Filters</button>' : '');
        }
        
        function renderTableBody() {
            const tbody = document.getElementById('tableBody');
            const noData = document.getElementById('noData');
            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                noData.style.display = 'block';
                return;
            }
            noData.style.display = 'none';
            
            // Find duplicate bids_name values in filteredData
            const bidsNameCounts = {};
            filteredData.forEach(row => {
                const name = row.bids_name || '';
                if (name) {
                    bidsNameCounts[name] = (bidsNameCounts[name] || 0) + 1;
                }
            });
            tbody.innerHTML = filteredData.map((row, rowIndex) => {
                const originalIndex = row._originalIndex;
                const isModified = modifiedRows.has(originalIndex);
                const isSkip = row.status && row.status.toLowerCase() === 'skip';
                const isDuplicate = row.bids_name && bidsNameCounts[row.bids_name] > 1;
                const rowClass = `${isModified ? 'modified' : ''} ${isSkip ? 'skip-row' : ''} ${isDuplicate ? 'duplicate-row' : ''}`.trim();
                return `
                <tr class="${rowClass}" data-index="${originalIndex}">
                    <td><input type="checkbox" class="bulk-row-checkbox" data-index="${originalIndex}" onchange="toggleBulkRow(${originalIndex}, this.checked)"></td>
                    ${(() => {
                        let orderedCols = columns.filter(col => !hiddenColumns.includes(col) && col !== 'event_id' && col !== 'participant_to' && col !== 'session_to');
                        // Move status to first, then raw_name, then task
                        const statusIdx = orderedCols.indexOf('status');
                        if (statusIdx > 0) {
                            orderedCols.splice(statusIdx, 1);
                            orderedCols.unshift('status');
                        }
                        const rawNameIdx = orderedCols.indexOf('raw_name');
                        if (rawNameIdx > 1) {
                            orderedCols.splice(rawNameIdx, 1);
                            orderedCols.splice(1, 0, 'raw_name');
                        }
                        const taskIdx = orderedCols.indexOf('task');
                        if (taskIdx > 2) {
                            orderedCols.splice(taskIdx, 1);
                            orderedCols.splice(2, 0, 'task');
                        }
                        return orderedCols.map(col => {
                            let value = row[col] || '';
                            let displayValue = value;
                            let tdClass = '';
                            // Format status with dropdown
                            if (col.toLowerCase() === 'status') {
                                const statusClass = 'status-' + value.toLowerCase().replace(/\s+/g, '-');
                                tdClass = 'editable-cell';
                                displayValue = `
                                    <select onchange="updateCell(${originalIndex}, '${col}', this.value)" style="border: none; background: transparent; font-weight: 600;">
                                        ${statusOptions.map(opt => `
                                            <option value="${opt}" ${opt === value ? 'selected' : ''} class="status-badge status-${opt}">
                                                ${opt}
                                            </option>
                                        `).join('')}
                                    </select>
                                `;
                            }
                            // Editable text fields
                            else if (editableColumns.includes(col)) {
                                tdClass = 'editable-cell';
                                displayValue = `<input type="text" value="${value}" onchange="updateCell(${originalIndex}, '${col}', this.value)" />`;
                            }
                            // Format file paths
                            else if (col.toLowerCase().includes('path') || col.toLowerCase().includes('file')) {
                                displayValue = `<span class="file-path">${value}</span>`;
                            }
                            // Highlight duplicate bids_name
                            if (col === 'bids_name' && isDuplicate) {
                                tdClass += ' duplicate-cell';
                                displayValue = `<span style='color:#c0392b;font-weight:bold;' title='Duplicate bids_name'>${value} ‚ö†Ô∏è</span>`;
                            }
                            return `<td class="${tdClass} col-${col}">${displayValue}</td>`;
                        }).join('');
                    })()}
                </tr>
            `}).join('');
        }
        
        let bulkSelectedRows = new Set();
        function toggleBulkRow(index, checked) {
            if (checked) {
                bulkSelectedRows.add(index);
            } else {
                bulkSelectedRows.delete(index);
            }
        }
        function toggleBulkSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.bulk-row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                toggleBulkRow(parseInt(cb.dataset.index), checkbox.checked);
            });
        }
        function bulkChangeStatus(newStatus) {
            bulkSelectedRows.forEach(idx => {
                if (allData[idx]) {
                    allData[idx].status = newStatus;
                    updateBidsName(allData[idx]);
                    modifiedRows.add(idx);
                    manualStatusChanges.add(idx);
                }
            });
            document.getElementById('saveButton').disabled = false;
            document.getElementById('resetButton').disabled = false;
            bulkSelectedRows.clear();
            filterData();
        }
        
        function updateCell(originalIndex, column, newValue) {
            // Update by direct array index - no ambiguity
            if (originalIndex >= 0 && originalIndex < allData.length) {
                const row = allData[originalIndex];
                row[column] = newValue;
                
                // Track manual status changes
                if (column === 'status') {
                    manualStatusChanges.add(originalIndex);
                }
                
                // Auto-update bids_name when task, run, or split changes
                if (['task', 'run', 'split'].includes(column)) {
                    updateBidsName(row);
                }
                
                modifiedRows.add(originalIndex);
                
                // Enable save and reset buttons
                document.getElementById('saveButton').disabled = false;
                document.getElementById('resetButton').disabled = false;
                
                // Re-render to show modified state
                filterData();
            }
        }
        
        function updateBidsName(row) {
            // BIDS standard order:
            // sub-<label>[_ses-<label>]_task-<label>[_acq-<label>][_run-<index>][_proc-<label>][_split-<index>]_meg.<extension>
            let parts = [];
            // Subject (required)
            if (row.participant_from) {
                parts.push(`sub-${row.participant_from}`);
            }
            // Session (optional)
            if (row.session_from) {
                parts.push(`ses-${row.session_from}`);
            }
            // Task (required)
            if (row.task && row.task.trim()) {
                parts.push(`task-${row.task.trim()}`);
            }
            // Acquisition (optional)
            if (row.acq && row.acq.trim()) {
                parts.push(`acq-${row.acq.trim()}`);
            } else if (row.bids_name) {
                const acqMatch = row.bids_name.match(/acq-([^_]+)/);
                if (acqMatch) {
                    parts.push(`acq-${acqMatch[1]}`);
                }
            }
            // Run (optional)
            if (row.run && row.run.trim()) {
                parts.push(`run-${row.run.trim()}`);
            }
            // Proc (optional)
            if (row.proc && row.proc.trim()) {
                parts.push(`proc-${row.proc.trim()}`);
            } else if (row.bids_name) {
                const procMatch = row.bids_name.match(/proc-([^_]+)/);
                if (procMatch) {
                    parts.push(`proc-${procMatch[1]}`);
                }
            }
            // Split (optional)
            if (row.split && row.split.trim()) {
                parts.push(`split-${row.split.trim()}`);
            }
            // Suffix (default to _meg.fif, fallback to original)
            let suffix = '_meg.fif';
            if (row.bids_name) {
                const suffixMatch = row.bids_name.match(/(_meg\.[a-z0-9]+|_eeg\.[a-z0-9]+|\.[a-z0-9]+)$/);
                if (suffixMatch) {
                    suffix = suffixMatch[0];
                }
            }
            // Join all parts
            row.bids_name = parts.join('_') + suffix;
        }
        
        function resetChanges() {
            if (confirm('‚ö†Ô∏è Are you sure you want to discard all changes?\n\nThis will reload the original data from the file.')) {
                // Restore original data (preserving _originalIndex)
                allData = JSON.parse(JSON.stringify(originalData));
                modifiedRows.clear();
                manualStatusChanges.clear();
                
                // Disable buttons
                document.getElementById('saveButton').disabled = true;
                document.getElementById('resetButton').disabled = true;
                
                // Re-render
                filterData();
            }
        }
        
        async function saveChanges() {
            // Change status to "run" for modified rows, except those with manual status changes
            let autoChangedCount = 0;
            modifiedRows.forEach(originalIndex => {
                if (allData[originalIndex] && !manualStatusChanges.has(originalIndex)) {
                    allData[originalIndex].status = 'run';
                    autoChangedCount++;
                }
            });
            
            // Convert data back to TSV format (exclude _originalIndex)
            const tsvLines = [
                columns.join('\t'),
                ...allData.map(row => 
                    columns.map(col => row[col] || '').join('\t')
                )
            ];
            const tsvContent = tsvLines.join('\n');
            
            // Download the file with the same name
            const blob = new Blob([tsvContent], { type: 'text/tab-separated-values' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFilePath;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Clear modified state
            modifiedRows.clear();
            manualStatusChanges.clear();
            document.getElementById('saveButton').disabled = true;
            document.getElementById('resetButton').disabled = true;
            
            // Update original data to current state
            originalData = JSON.parse(JSON.stringify(allData));
            
            let message = '‚úÖ File downloaded: ' + currentFilePath;
            if (autoChangedCount > 0) {
                message += '\n\n' + autoChangedCount + ' modified row(s) set to status: run';
            }
            message += '\n\nPlease replace the original file with the downloaded version.';
            alert(message);
            
            filterData();
        }
        
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            filteredData.sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';
                
                // Try to parse as numbers
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return sortDirection === 'asc' ? numA - numB : numB - numA;
                }
                
                // String comparison
                return sortDirection === 'asc' 
                    ? String(valA).localeCompare(String(valB))
                    : String(valB).localeCompare(String(valA));
            });
            
            renderTableHead();
            renderTableBody();
        }
        
        function updateFilter(column, value) {
            if (value) {
                filterValues[column] = value;
            } else {
                delete filterValues[column];
            }
            filterData();
        }
        
        function clearFilters() {
            filterValues = {};
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.filter-group select').forEach(select => {
                select.value = '';
            });
            filterData();
        }
        
        // Listen for messages from parent window (Electron main app)
        window.addEventListener('message', async (event) => {
            if (event.data && event.data.type === 'loadFile') {
                const fileData = event.data.data;
                if (fileData && fileData.content) {
                    const loading = document.getElementById('loading');
                    const table = document.getElementById('dataTable');
                    const errorDiv = document.getElementById('errorMessage');

                    loading.style.display = 'block';
                    loading.innerHTML = 'Loading conversion table...';
                    table.style.display = 'none';
                    errorDiv.innerHTML = '';

                    try {
                        const text = fileData.content;
                        
                        // Store the full file path for saving
                        currentFilePath = fileData.path;
                        
                        // Parse TSV
                        const lines = text.trim().split('\n');
                        const headers = lines[0].split('\t');
                        columns = headers;
                        
                        allData = lines.slice(1).map(line => {
                            const values = line.split('\t');
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = values[index] || '';
                            });
                            return obj;
                        });
                        
                        // Add unique index to each row
                        allData.forEach((row, index) => {
                            row._originalIndex = index;
                        });
                        
                        // Store a deep copy of original data
                        originalData = JSON.parse(JSON.stringify(allData));
                        
                        filterData();
                        renderTable();
                        loading.style.display = 'none';
                        table.style.display = 'table';
                        
                        console.log('‚úÖ Conversion table loaded successfully from parent window');
                    } catch (error) {
                        loading.style.display = 'none';
                        errorDiv.innerHTML = `<div class="error">‚ùå Error loading file: ${error.message}</div>`;
                        console.error('Error loading file:', error);
                    }
                }
            }
        });
    </script>
    <script src="electron/renderer.js"></script>
</body>
</html>